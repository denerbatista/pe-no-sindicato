<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Desfiliação — Prefeitura de Aracruz (PDF + Assinatura)</title>
  <meta name="color-scheme" content="light dark" />
  <style>
    :root { --bg:#0b0c0f; --card:#12141a; --text:#e7e9ee; --muted:#a9b0bd;
            --accent:#5b9cff; --accent-2:#27c3a8; --danger:#ff6b6b; color-scheme: light dark; }
    @media (prefers-color-scheme: light) {
      :root { --bg:#f7f8fa; --card:#ffffff; --text:#0b0c0f; --muted:#5a6472; }
    }
    *{box-sizing:border-box}
    body{margin:0;padding:16px;background:var(--bg);color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Helvetica Neue",Arial,system-ui,sans-serif;line-height:1.35;}
    .wrap{max-width:760px;margin:0 auto;}
    header{text-align:center;margin:6px 0 14px;}
    h1{font-size:clamp(20px,4.5vw,28px);margin:0 0 6px;}
    p.lead{margin:0;color:var(--muted);font-size:.98rem;}
    .card{background:var(--card);border-radius:16px;padding:14px;margin:14px 0;
      box-shadow:0 6px 22px rgba(0,0,0,.10);border:1px solid rgba(255,255,255,.06);}
    .grid{display:grid;gap:10px;grid-template-columns:1fr 1fr;}
    .grid-1{grid-template-columns:1fr;}
    @media (max-width:640px){.grid{grid-template-columns:1fr;}}
    label{display:block;font-size:.9rem;margin:2px 2px 6px;color:var(--muted);}
    input,select,textarea{width:100%;border:1px solid rgba(0,0,0,.12);background:transparent;color:var(--text);
      padding:12px;border-radius:12px;font-size:16px;outline:none;}
    input[readonly]{opacity:.8;background:rgba(0,0,0,.04);}
    textarea{min-height:110px;resize:vertical;}
    .row{display:flex;gap:10px;flex-wrap:wrap;}
    .row>*{flex:1 1 180px;}
    .help{color:var(--muted);font-size:.85rem;margin-top:6px;}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:.55rem;
      padding:12px 14px;font-weight:600;border-radius:12px;border:none;background:var(--accent);
      color:white;width:100%;cursor:pointer;text-decoration:none;font-size:16px;}
    .btn.secondary{background:#2f3340;color:var(--text);}
    .btn.safe{background:var(--accent-2);}
    .btn.danger{background:var(--danger);}
    .btn:disabled{opacity:.6;cursor:not-allowed;}
    .actions{display:grid;gap:10px;grid-template-columns:1fr;}
    .preview{white-space:pre-wrap;background:rgba(0,0,0,.06);padding:12px;border-radius:12px;
      font-family:ui-sans-serif,system-ui,-apple-system,Roboto,Arial;border:1px dashed rgba(255,255,255,.12);}
    .tag{font-size:.75rem;padding:3px 8px;border-radius:999px;background:rgba(0,0,0,.08);color:var(--muted);display:inline-block;}
    footer{text-align:center;color:var(--muted);font-size:.85rem;margin:16px 0 0;}

    /* Área de assinatura */
    .sig-wrap{border:1px dashed rgba(255,255,255,.2);border-radius:12px;background:rgba(0,0,0,.04);padding:10px;}
    .sig-toolbar{display:flex;gap:8px;justify-content:space-between;align-items:center;margin-bottom:8px;}
    .sig-toolbar .left{display:flex;gap:8px;align-items:center;}
    canvas#signature{width:100%;height:180px;background:rgba(0,0,0,.02);border-radius:8px;touch-action:none;}
    .small{font-size:.82rem;color:var(--muted);}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Desfiliação Sindical — Prefeitura de Aracruz</h1>
      <p class="lead">Preencha os dados e gere o PDF. Assine com o dedo ou deixe para assinar via Gov.br depois.</p>
    </header>

    <form id="form" class="card" onsubmit="event.preventDefault(); gerarPDF();">
      <div class="grid">
        <div>
          <label for="nome">Nome completo*</label>
          <input id="nome" required autocomplete="name" placeholder="Seu nome" />
        </div>
        <div>
          <label for="cpf">CPF*</label>
          <input id="cpf" required inputmode="numeric" placeholder="000.000.000-00" pattern="[0-9.\\- ]{11,14}" />
        </div>

        <!-- Empregador fixo -->
        <div class="grid-1">
          <label for="empresa">Empregador</label>
          <input id="empresa" value="Prefeitura de Aracruz" readonly />
        </div>

        <div>
          <label for="matricula">Matrícula/Registro</label>
          <input id="matricula" placeholder="Opcional" />
        </div>
        <div class="grid-1">
          <label for="endereco">Endereço</label>
          <input id="endereco" autocomplete="street-address" placeholder="Rua, nº, bairro, cidade/UF" />
        </div>
        <div>
          <label for="local">Local (cidade/UF)*</label>
          <input id="local" required placeholder="Ex.: Aracruz/ES" />
        </div>
        <div>
          <label for="data">Data</label>
          <input id="data" type="date" />
        </div>

        <!-- Sindicato limitado -->
        <div>
          <label for="sindicatoSel">Sindicato*</label>
          <select id="sindicatoSel" required>
            <option value="" disabled selected>Selecione</option>
            <option value="SISMA">SISMA</option>
            <option value="SINDUPES">SINDUPES</option>
          </select>
        </div>
      </div>

      <div class="grid" style="margin-top:10px">
        <div class="grid-1">
          <label for="observacoes">Observações adicionais (opcional)</label>
          <textarea id="observacoes" placeholder="Ex.: Favor confirmar em até 5 dias úteis."></textarea>
        </div>
      </div>

      <!-- Escolha de assinatura -->
      <div class="card">
        <label style="margin-bottom:8px;">Assinatura</label>
        <div class="row">
          <label style="display:flex;align-items:center;gap:8px;">
            <input type="radio" name="assinaturaModo" value="agora" checked />
            Assinar agora com o dedo (recomendado)
          </label>
          <label style="display:flex;align-items:center;gap:8px;">
            <input type="radio" name="assinaturaModo" value="depois" />
            Gerar sem assinatura (assinar via Gov.br depois)
          </label>
        </div>

        <div id="sigArea" class="sig-wrap" style="margin-top:10px;">
          <div class="sig-toolbar">
            <div class="left">
              <button class="btn secondary" type="button" id="sigLimpar">Limpar assinatura</button>
              <button class="btn secondary" type="button" id="sigDesfazer">Desfazer</button>
            </div>
            <span class="small">Assine na área abaixo com o dedo ou caneta.</span>
          </div>
          <canvas id="signature"></canvas>
        </div>

        <p class="help" style="margin-top:8px">
          Se escolher “Gerar sem assinatura”, o PDF terá espaço para assinatura. Depois você pode
          assinar digitalmente no <b>Gov.br Assinatura</b> ou outro serviço equivalente.
        </p>
      </div>

      <div class="row" style="margin-top:12px">
        <button class="btn safe" type="submit">Gerar PDF</button>
        <button class="btn secondary" type="button" onclick="limparTudo()">Limpar</button>
      </div>
    </form>

    <section id="saida" class="card" hidden>
      <strong>Pré-visualização (texto)</strong>
      <div id="preview" class="preview" style="margin-top:8px"></div>

      <div class="actions" style="margin-top:12px">
        <a id="btnBaixarPDF" class="btn" href="#" download="carta-desfiliacao.pdf">Baixar PDF</a>
        <button class="btn secondary" type="button" onclick="editar()">Voltar e editar</button>
      </div>

      <p class="help" style="margin-top:10px">
        Dica: abra o PDF para conferir. Se optou por “assinar depois”, o documento
        terá um campo em branco para assinatura.
      </p>
    </section>

    <footer>
      <p>Guarde os comprovantes de envio/protocolo.</p>
    </footer>
  </div>

  <!-- jsPDF CDN para gerar o PDF -->
  <script defer src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <script>
    const $ = (id) => document.getElementById(id);

    // Canvas de assinatura
    const canvas = document.getElementById('signature');
    const ctx = canvas.getContext('2d');
    let drawing = false;
    let strokes = []; // para desfazer
    let currentStroke = [];

    // Ajusta resolução do canvas conforme tamanho do container e DPR
    function resizeCanvas(){
      const rect = canvas.getBoundingClientRect();
      const ratio = Math.max(window.devicePixelRatio || 1, 1);
      canvas.width = Math.floor(rect.width * ratio);
      canvas.height = Math.floor(rect.height * ratio);
      ctx.scale(ratio, ratio);
      // Redesenha traços guardados ao redimensionar
      redrawStrokes();
    }

    function startDraw(x, y){
      drawing = true;
      currentStroke = [{x,y}];
      ctx.lineWidth = 2.2;
      ctx.lineCap = 'round';
      ctx.lineJoin = 'round';
      ctx.beginPath();
      ctx.moveTo(x, y);
    }

    function moveDraw(x, y){
      if(!drawing) return;
      currentStroke.push({x,y});
      ctx.lineTo(x, y);
      ctx.stroke();
    }

    function endDraw(){
      if(!drawing) return;
      drawing = false;
      ctx.closePath();
      if(currentStroke.length) strokes.push(currentStroke);
      currentStroke = [];
    }

    function clearSig(){
      strokes = [];
      currentStroke = [];
      ctx.clearRect(0,0,canvas.width,canvas.height);
    }

    function undoSig(){
      if(!strokes.length) return;
      strokes.pop();
      ctx.clearRect(0,0,canvas.width,canvas.height);
      redrawStrokes();
    }

    function redrawStrokes(){
      ctx.lineWidth = 2.2;
      ctx.lineCap = 'round';
      ctx.lineJoin = 'round';
      ctx.beginPath();
      let first = true;
      for(const stroke of strokes){
        for(let i=0;i<stroke.length;i++){
          const p = stroke[i];
          if(first){ ctx.moveTo(p.x, p.y); first=false; }
          else ctx.lineTo(p.x, p.y);
        }
      }
      ctx.stroke();
      ctx.closePath();
    }

    // Eventos mouse/touch
    function getPos(e){
      const rect = canvas.getBoundingClientRect();
      if(e.touches && e.touches[0]){
        return {
          x: (e.touches[0].clientX - rect.left),
          y: (e.touches[0].clientY - rect.top)
        };
      } else {
        return { x: (e.clientX - rect.left), y: (e.clientY - rect.top) };
      }
    }

    canvas.addEventListener('mousedown', e => startDraw(...Object.values(getPos(e))));
    canvas.addEventListener('mousemove', e => moveDraw(...Object.values(getPos(e))));
    canvas.addEventListener('mouseup', endDraw);
    canvas.addEventListener('mouseleave', endDraw);

    canvas.addEventListener('touchstart', e => { e.preventDefault(); startDraw(...Object.values(getPos(e))); }, {passive:false});
    canvas.addEventListener('touchmove', e => { e.preventDefault(); moveDraw(...Object.values(getPos(e))); }, {passive:false});
    canvas.addEventListener('touchend', e => { e.preventDefault(); endDraw(); }, {passive:false});

    window.addEventListener('resize', resizeCanvas);

    // Botões assinatura
    document.getElementById('sigLimpar').addEventListener('click', clearSig);
    document.getElementById('sigDesfazer').addEventListener('click', undoSig);

    // Mostrar/esconder área de assinatura conforme opção
    document.querySelectorAll('input[name="assinaturaModo"]').forEach(r => {
      r.addEventListener('change', () => {
        const modo = document.querySelector('input[name="assinaturaModo"]:checked').value;
        document.getElementById('sigArea').style.display = (modo === 'agora') ? 'block' : 'none';
      });
    });

    // Estado do PDF
    let pdfURL = null;

    // Data padrão = hoje
    (function init(){
      const hoje = new Date();
      $('data').value = hoje.toISOString().slice(0,10);
      // Inicializa canvas
      setTimeout(resizeCanvas, 50);
    })();

    function validarObrigatorios() {
      const ids = ["nome","cpf","local","sindicatoSel"];
      return ids.every(id => $(id).value && $(id).value.trim());
    }

    function gerarAssunto() {
      const nome = $('nome').value.trim();
      const cpf = $('cpf').value.replace(/\D/g,"");
      const cpfFmt = cpf ? cpf.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/,"$1.$2.$3-$4") : "";
      const sindicato = $('sindicatoSel').value || "Sindicato";
      return `Pedido de Desfiliação — ${nome}${cpfFmt ? " — CPF " + cpfFmt : ""} — ${sindicato}`;
    }

    function montarTextoCarta() {
      const nome = $('nome').value.trim();
      const cpf = $('cpf').value.trim();
      const empresa = $('empresa').value.trim(); // fixo
      const matricula = $('matricula').value.trim();
      const endereco = $('endereco').value.trim();
      const local = $('local').value.trim();
      const data = $('data').value ? new Date($('data').value) : new Date();
      const dataFmt = data.toLocaleDateString('pt-BR');
      const sindicato = $('sindicatoSel').value;
      const obs = $('observacoes').value.trim();

      const header = `${nome}
CPF: ${cpf}${matricula ? `  •  Matrícula: ${matricula}` : ""}\nEmpregador: ${empresa}${endereco ? `\nEndereço: ${endereco}` : ""}`;

      const corpo = `Ao Sindicato ${sindicato}
A/C: Diretoria

Assunto: Pedido de Desfiliação

Prezados(as),

Por meio desta, solicito minha **imediata desfiliação** deste sindicato, bem como a suspensão de quaisquer descontos em folha referentes a contribuições sindicais, assistenciais, confederativas ou de qualquer outra natureza, a partir desta data.

Solicito, ainda, o protocolo deste pedido e o envio de comprovante de recebimento. Informo também à Prefeitura de Aracruz como empregadora.

${obs ? "Observações: " + obs + "\n\n" : ""}Sem mais, agradeço pela atenção.

${local}, ${dataFmt}

____________________________________
${nome}`;

      return header + "\n\n" + corpo;
    }

    async function gerarPDF() {
      if (!validarObrigatorios()) { alert("Preencha os campos marcados com *"); return; }

      const texto = montarTextoCarta();
      $('preview').textContent = texto;
      $('saida').hidden = false;

      const modo = document.querySelector('input[name="assinaturaModo"]:checked').value;
      const incluirAssinatura = (modo === 'agora' && strokes.length > 0);

      try {
        const { jsPDF } = window.jspdf || {};
        if (!jsPDF) throw new Error("jsPDF não carregou.");

        const doc = new jsPDF({ unit: "pt", format: "a4" });
        const margem = 56;
        const largura = doc.internal.pageSize.getWidth() - margem*2;
        const altura = doc.internal.pageSize.getHeight();

        // Texto
        doc.setFont("Times","Normal");
        doc.setFontSize(13);

        const linhas = doc.splitTextToSize(texto, largura);
        let y = margem;
        for (const l of linhas) {
          if (y > altura - margem - 160) { // reserva espaço para assinatura se necessário
            doc.addPage(); y = margem;
          }
          doc.text(l, margem, y);
          y += 18;
        }

        // Área de assinatura no PDF
        const assinaturaTop = y + 20;
        const linhaY = assinaturaTop + 70;

        // Se assinando depois, deixa espaço e legenda
        // Se assinou no canvas, insere a imagem da assinatura
        doc.setFontSize(11);
        doc.setDrawColor(150);
        doc.setLineWidth(0.7);

        // Caixa/linha de assinatura
        doc.line(margem, linhaY, margem + 300, linhaY);

        if (incluirAssinatura) {
          // Exporta assinatura do canvas em tamanho adequado
          const dataUrl = exportSignaturePNG();
          // Insere a assinatura (ajusta para caber)
          doc.addImage(dataUrl, 'PNG', margem, assinaturaTop, 300, 60);
          doc.text("Assinado digitalmente (captura de assinatura manual)", margem, linhaY + 14);
        } else {
          doc.text("Assinatura do(a) servidor(a)", margem, linhaY + 14);
          doc.text("Este documento foi gerado sem assinatura para posterior assinatura digital (ex.: Gov.br).", margem, linhaY + 30);
        }

        // Nome abaixo
        const nome = $('nome').value.trim();
        doc.text(nome, margem, linhaY + 46);

        // Gera Blob/URL para download
        const blob = doc.output('blob');
        if (pdfURL) URL.revokeObjectURL(pdfURL);
        pdfURL = URL.createObjectURL(blob);

        const nomeArquivo = `desfiliacao-aracruz-${(nome||"servidor").toLowerCase().replace(/\s+/g,"-")}.pdf`;
        const linkBaixar = $('btnBaixarPDF');
        linkBaixar.href = pdfURL;
        linkBaixar.download = nomeArquivo;

        // rola para as ações
        window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" });

      } catch (e) {
        console.error(e);
        alert("Falha ao gerar o PDF. Tente novamente.");
      }
    }

    function exportSignaturePNG(){
      // Cria um canvas “limpo” do tamanho em CSS para exportar a assinatura
      const rect = canvas.getBoundingClientRect();
      const tmp = document.createElement('canvas');
      tmp.width = rect.width;
      tmp.height = rect.height;
      const tctx = tmp.getContext('2d');
      // redesenha os strokes no tamanho CSS (sem DPR) para evitar distorção
      tctx.lineWidth = 2.2;
      tctx.lineCap = 'round';
      tctx.lineJoin = 'round';
      tctx.beginPath();
      let first = true;
      for(const stroke of strokes){
        for(let i=0;i<stroke.length;i++){
          const p = stroke[i];
          if(first){ tctx.moveTo(p.x, p.y); first=false; }
          else tctx.lineTo(p.x, p.y);
        }
      }
      tctx.stroke();
      tctx.closePath();
      return tmp.toDataURL('image/png');
    }

    function editar(){ $('saida').hidden = true; window.scrollTo({top:0, behavior:"smooth"}); }

    function limparTudo(){
      document.getElementById('form').reset();
      $('empresa').value = 'Prefeitura de Aracruz';
      $('data').value = new Date().toISOString().slice(0,10);
      $('saida').hidden = true;
      if (pdfURL) { URL.revokeObjectURL(pdfURL); pdfURL = null; }
      // assinatura
      clearSig();
      // volta opção padrão (assinar agora)
      document.querySelector('input[name="assinaturaModo"][value="agora"]').checked = true;
      document.getElementById('sigArea').style.display = 'block';
    }
  </script>
</body>
</html>
